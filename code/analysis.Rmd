---
title: "Laptop Pricing"
author: "Attila Szuts"
date: "02/01/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r}
rm(list = ls())
library(tidyverse); library(janitor)
laptops <- "data/raw/laptop-price/"
raw1 <- read_csv(paste0(laptops, "laptop_price.csv")) %>% clean_names()
```

```{r}
pattern <- "([:digit:]{3,4}x[:digit:]{3,4})" # pattern to match screen resolutions
  
# data cleaning
laptop <- raw1 %>% 
  mutate(ram = as.numeric(gsub("GB", "", raw1$ram)), # convert RAM to numeric, in GB
         weight = as.numeric(gsub("kg", "", raw1$weight))) %>% # convert weight to numeric, in kg
  # create group dummies for screen size
  mutate(screen_small = ifelse(inches < 15, T, F), 
         screen_mid = ifelse(inches >= 15 & inches < 17, T, F),
         screen_big = ifelse(inches >= 17, T, F)) %>% 
  # extract resolution
  mutate(touchscreen = ifelse(grepl("Touchscreen", raw1$screen_resolution), T, F), # touchscreen dummy
         ips = ifelse(grepl("IPS", raw1$screen_resolution), T, F), # IPS display dummy
         resolution = str_extract_all(raw1$screen_resolution, pattern, simplify = T)) %>% 
  select(-screen_resolution) %>% 
  mutate(cpu = tolower(trimws(cpu))) %>% # trim whitespace
  add_column(lencpu = sapply(strsplit(raw1$cpu, " "), length))

  
# number of words in cpu column
temp <- laptop %>% 
  group_by(cpu) %>% 
  summarise(count = n())
temp <- temp %>% 
  add_column(lencpu = sapply(strsplit(temp$cpu, " "), length)) %>% 
  arrange(lencpu, cpu)

# function that extract cpu manufacturer, cpu model, cpu model variant, cpu frequency and number of cores
cpuMan <- function(x) {
  outlist <- c()
  for (e in 1:length(x$cpu)) {
    outlist <- c(outlist, strsplit(x$cpu[e], split = " ")[[1]][[1]])
  }
  return(outlist)
}
cpuModel <- function(x) {
  outlist <- c()
  for (e in 1:length(x$cpu)) {
    if (x$lencpu[e] == 5 & grepl("xeon", x$cpu[e]) != T)  {
      outlist <- c(outlist, paste(strsplit(x$cpu[e], split = " ")[[1]][[2]], strsplit(x$cpu[e], split = " ")[[1]][[3]]))
    } else if (x$lencpu[e] == 4 & x$cpu_manufac[e] == "intel") {
      outlist <- c(outlist, paste(strsplit(x$cpu[e], split = " ")[[1]][[2]], strsplit(x$cpu[e], split = " ")[[1]][[3]]))
    } else {
      outlist <- c(outlist, strsplit(x$cpu[e], split = " ")[[1]][[2]])
    }
  }
  return(outlist)
}
cpuVariant <- function(x) {
  outlist <- c()
  for (e  in 1:length(x$cpu)) {
    if (x$lencpu[e] == 4 & x$cpu_manufac[e] != "amd") {
      outlist <- c(outlist, NA)
    } else if (x$lencpu[e] == 4) {
      outlist <- c(outlist, strsplit(x$cpu[e], split = " ")[[1]][[3]])
    } else if (x$lencpu[e] == 5 & grepl("xeon", x$cpu[e]) != T) {
      outlist <- c(outlist, strsplit(x$cpu[e], split = " ")[[1]][[4]])
    } else if (x$lencpu[e] == 5 & grepl("xeon", x$cpu[e]) == T) {
      outlist <- c(outlist, paste(strsplit(x$cpu[e], split = " ")[[1]][[3]], strsplit(x$cpu[e], split = " ")[[1]][[4]]))
    } else {
      outlist <- c(outlist, strsplit(x$cpu[e], split = " ")[[1]][[5]])
    }
  }
  return(outlist)
}
cpuFreq <- function(x) {
  outlist <- c()
  for (e in 1:length(x$cpu)) {
    if (x$lencpu[e] == 4) {
      outlist <- c(outlist, strsplit(x$cpu[e], split = " ")[[1]][[4]])
    } else if (x$lencpu[e] == 5) {
      outlist <- c(outlist, strsplit(x$cpu[e], split = " ")[[1]][[5]])
    } else {
      outlist <- c(outlist, strsplit(x$cpu[e], split = " ")[[1]][[6]])
    }
  }
  return(outlist)
}
cpuCores <- function(x) {
  outlist <- c()
  for (e in 1:length(x$cpu)) {
    if (x$lencpu[e] == 6) {
      outlist <- c(outlist, paste(strsplit(x$cpu[e], split = " ")[[1]][[3]], strsplit(x$cpu[e], split = " ")[[1]][[4]]))
    } else {
      outlist <- c(outlist, NA)
    }
  }
  return(outlist)
}
# create function that extracts storage size and type
memory <- function(x) {
  outlist <- list()
  ssd <- c()
  hdd <- c()
  for (e in 1:length(x$memory)) {
    if (x$ssd[e] == T & x$hdd[e] == F) {
      ssd <- c(ssd, str_extract(x$memory[e], "[:digit:]+tb|[:digit:]+gb")[[1]])
      hdd <- c(hdd, 0)
    } else if (x$ssd[e] == F & x$hdd[e] == T) {
      hdd <- c(hdd, str_extract(x$memory[e], "[:digit:]+tb|[:digit:]+gb|1\\.0tb")[[1]])
      ssd <- c(ssd, 0)
    } else {
      tryCatch(
        expr = {
          if (grepl("hybrid", x$memory[e])) {
            hdd <- c(hdd, str_extract_all(x$memory[e], "[:digit:]+gb|[:digit:]+\\.*[:digit:]*tb")[[1]][[1]])
            ssd <- c(ssd, 0)
          } else {
            ssd <- c(ssd, str_extract_all(x$memory[e], "[:digit:]+gb|[:digit:]+\\.*[:digit:]*tb")[[1]][[1]])
            hdd <- c(hdd, str_extract_all(x$memory[e], "[:digit:]+gb|[:digit:]+\\.*[:digit:]*tb")[[1]][[2]])
          }},
        error = function(er) {
          message("there was an error")
          print(laptop$memory[e])
          if (x$ssd[e] == T & x$hdd[e] == F) {
            print("ssd")
          } else if (x$ssd[e] == F & x$hdd[e] == T) {
            print("hdd")
          } else {
            print(paste(str_extract_all(x$memory[e], "[:digit:]+gb|[:digit:]+\\.*[:digit:]*tb")[[1]][[1]], str_extract_all(x$memory[e], "[:digit:]+gb|[:digit:]+\\.*[:digit:]*tb")[[1]][[2]]))
          }
          }
        )
    }
  }
  outlist <- list(ssd = ssd, hdd = hdd)
  return(outlist)
}

# create function that extracts gpu manufacturers
gpuMan <- function(x) {
  outlist <- c()
  for (e in 1:length(x$gpu)) {
    outlist <- c(outlist, strsplit(x$gpu[e], split = " ")[[1]][[1]])
  }
  return(outlist)
}

# add new columns with cleaned cpu data
laptop <- laptop %>% 
  add_column(cpu_manufac = cpuMan(laptop)) # extract manufacturer
laptop <- laptop %>% 
  add_column(cpu_model = cpuModel(laptop), # extract cpu model 
             cpu_model_variant = cpuVariant(laptop), # extract cpu model variant
             cpu_freq = cpuFreq(laptop), # extract cpu clock frequency
             cpu_cores = cpuCores(laptop) # extract cpu cores
             ) %>% 
  mutate(cpu_freq = as.numeric(gsub("ghz", "", cpu_freq, ignore.case = T))) %>% 
  select(-c(lencpu, cpu_cores, cpu)) %>% 
  # clean memory
  mutate(memory = tolower(trimws(memory)), 
         ssd = ifelse(grepl("ssd|flash|hybrid", memory), T, F), # create ssd dummy
         hdd = ifelse(grepl("hdd|hybrid", memory), T, F)) # create hdd dummy

laptop <- laptop %>% 
  add_column(ssd_size = memory(laptop)["ssd"][[1]], hdd_size = memory(laptop)["hdd"][[1]]) %>%  # add column for ssd and hdd size
  mutate(hdd_size = ifelse(grepl("tb", hdd_size), as.numeric(gsub("tb", "", hdd_size))*1000, as.numeric(gsub("gb", "", hdd_size))), # transform to GB
         ssd_size = ifelse(grepl("gb", ssd_size), as.numeric(gsub("gb", "", ssd_size)), as.numeric(gsub("tb", "", ssd_size))*1000), # transform to GB
         gpu = tolower(trimws(gpu)),
         gpu_manufac = gpuMan(laptop))

# clean directory
rm(temp, pattern, cpuMan, cpuModel, cpuVariant, cpuFreq, cpuCores, raw1)
```

